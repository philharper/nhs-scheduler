<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NHS Cardiology Scheduler - Configure</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --md-primary: #19673b;
      --md-primary-weak: #deeee3;
      --md-on-primary: #ffffff;
      --md-surface: #ffffff;
      --md-surface-soft: #f7faf8;
      --md-bg: #eef2ef;
      --md-on-surface: #1a201c;
      --md-on-surface-muted: #5f675f;
      --md-outline: #c6cec8;
      --md-error: #b3261e;
      --md-shadow-1: 0 1px 2px rgba(0, 0, 0, 0.12);
      --md-shadow-2: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Roboto", "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 100% -10%, #dbece1 0%, transparent 35%),
        radial-gradient(circle at -10% 110%, #dfe8ff 0%, transparent 40%),
        var(--md-bg);
      color: var(--md-on-surface);
    }
    .app-shell { min-height: 100vh; }
    .wrap { max-width: 1420px; margin: 0 auto; padding: 20px 16px 36px; }
    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom: 1px solid var(--md-outline);
      background: color-mix(in srgb, var(--md-surface) 88%, transparent);
      backdrop-filter: blur(8px);
      box-shadow: var(--md-shadow-1);
    }
    .topbar-inner {
      max-width: 1420px;
      margin: 0 auto;
      padding: 12px 16px;
      display: grid;
      gap: 8px;
    }
    h1 { margin: 0; font-size: 1.45rem; letter-spacing: 0.01em; font-weight: 700; }
    .subtitle { margin: 0; color: var(--md-on-surface-muted); font-size: 0.95rem; }
    .nav { display: flex; gap: 8px; margin: 0; }
    .nav a {
      text-decoration: none;
      border: 1px solid var(--md-outline);
      border-radius: 999px;
      padding: 7px 14px;
      color: var(--md-on-surface);
      background: var(--md-surface);
      font-weight: 500;
      transition: background 120ms ease, border-color 120ms ease;
    }
    .nav a:hover { background: var(--md-surface-soft); }
    .nav a.active {
      border-color: transparent;
      background: var(--md-primary);
      color: var(--md-on-primary);
      box-shadow: var(--md-shadow-1);
    }
    .actions { display: flex; flex-wrap: wrap; gap: 10px; margin: 0 0 12px; }
    button {
      border: 0;
      border-radius: 999px;
      padding: 9px 14px;
      cursor: pointer;
      font-weight: 500;
      letter-spacing: 0.01em;
      color: var(--md-on-primary);
      background: var(--md-primary);
      box-shadow: var(--md-shadow-1);
      transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
    }
    button:hover { filter: brightness(1.04); box-shadow: var(--md-shadow-2); }
    button:active { transform: translateY(1px); }
    button.secondary {
      background: color-mix(in srgb, var(--md-primary) 16%, var(--md-surface));
      color: var(--md-primary);
      border: 1px solid color-mix(in srgb, var(--md-primary) 30%, transparent);
    }
    button.danger {
      background: color-mix(in srgb, var(--md-error) 18%, var(--md-surface));
      color: var(--md-error);
      border: 1px solid color-mix(in srgb, var(--md-error) 30%, transparent);
    }
    .message {
      margin-top: 8px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      display: none;
      box-shadow: var(--md-shadow-1);
    }
    .message.ok { background: var(--md-primary-weak); border-color: color-mix(in srgb, var(--md-primary) 35%, transparent); }
    .message.error { background: #fde9e8; border-color: #f3beb9; color: var(--md-error); }
    .panel {
      background: var(--md-surface);
      border: 1px solid var(--md-outline);
      border-radius: 16px;
      padding: 14px;
      margin-top: 14px;
      box-shadow: var(--md-shadow-2);
    }
    .panel h2 { margin: 0 0 10px; font-size: 1.1rem; font-weight: 600; }
    .table-wrap {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--md-outline);
    }
    table { width: 100%; border-collapse: collapse; min-width: 900px; background: #fcfefd; }
    th, td { border: 1px solid var(--md-outline); padding: 8px; vertical-align: top; }
    th { background: #edf4f0; text-align: left; font-weight: 600; }
    input, select, textarea {
      width: 100%;
      border: 1px solid var(--md-outline);
      border-radius: 10px;
      padding: 8px 10px;
      font: inherit;
      background: var(--md-surface);
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: color-mix(in srgb, var(--md-primary) 70%, transparent);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--md-primary) 16%, transparent);
    }
    .availability-list { display: grid; gap: 6px; }
    .availability-row {
      display: grid;
      grid-template-columns: 1.2fr 1fr 1fr auto;
      gap: 6px;
      align-items: center;
    }
    .tiny { font-size: 0.85rem; color: var(--md-on-surface-muted); }
    .options-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      margin-bottom: 8px;
    }
    .option-config-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .option-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--md-outline);
      border-radius: 999px;
      padding: 4px 8px;
      background: var(--md-surface-soft);
      box-shadow: var(--md-shadow-1);
    }
    .option-chip button {
      padding: 2px 8px;
      min-height: 26px;
      font-size: 0.78rem;
    }
    .option-grid {
      display: grid;
      gap: 6px;
    }
    .option-check {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .option-check input {
      width: auto;
    }
    @media (max-width: 720px) {
      .wrap { padding: 14px 10px 24px; }
      .topbar-inner { padding: 10px; }
      h1 { font-size: 1.2rem; }
      .subtitle { font-size: 0.86rem; }
      .panel { border-radius: 12px; padding: 10px; }
      .actions { gap: 8px; }
      button { padding: 9px 12px; }
      .options-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <div class="topbar">
    <div class="topbar-inner">
      <h1>NHS Cardiology Scheduler</h1>
      <p class="subtitle">Configure all rooms, employees, and sessions fields, then save to the shared file.</p>
      <div class="nav">
        <a href="/">Schedule</a>
        <a href="/config.html" class="active">Configure Data</a>
      </div>
    </div>
  </div>
  <div class="wrap">

    <div class="actions">
      <button id="loadBtn" class="secondary">Reload Saved Data</button>
      <button id="saveBtn">Save All Changes</button>
    </div>
    <div id="message" class="message"></div>

  <div class="panel">
    <h2>Configurable Purpose and Skill Values</h2>
    <div class="options-row">
      <input id="newPurposeInput" placeholder="Add room/session purpose (e.g. ecg)" />
      <button id="addPurposeBtn" type="button">Add Purpose</button>
    </div>
    <div id="purposeOptionsList" class="option-config-list"></div>
    <div class="options-row" style="margin-top: 12px;">
      <input id="newSkillInput" placeholder="Add employee/session skill (e.g. holter)" />
      <button id="addSkillBtn" type="button">Add Skill</button>
    </div>
    <div id="skillOptionsList" class="option-config-list"></div>
  </div>

  <div class="panel">
    <h2>Rooms</h2>
    <div class="actions"><button id="addRoomBtn" type="button">Add Room</button></div>
    <div class="table-wrap">
      <table>
        <thead>
        <tr><th>ID</th><th>Name</th><th>Purpose (single choice)</th><th>Action</th></tr>
        </thead>
        <tbody id="roomsBody"></tbody>
      </table>
    </div>
  </div>

  <div class="panel">
    <h2>Employees</h2>
    <div class="actions"><button id="addEmployeeBtn" type="button">Add Employee</button></div>
    <div class="table-wrap">
      <table>
        <thead>
        <tr><th>ID</th><th>Name</th><th>Skills (checkboxes)</th><th>Availability</th><th>Action</th></tr>
        </thead>
        <tbody id="employeesBody"></tbody>
      </table>
    </div>
    <p class="tiny">Availability times should support each assigned session window (4-hour sessions).</p>
  </div>

  <div class="panel">
    <h2>Sessions</h2>
    <div class="actions"><button id="addSessionBtn" type="button">Add Session</button></div>
    <div class="table-wrap">
      <table>
        <thead>
        <tr>
          <th>ID</th><th>Name</th><th>Required Skill</th><th>Purpose</th><th>Day</th><th>Start</th><th>End</th><th>Action</th>
        </tr>
        </thead>
        <tbody id="sessionsBody"></tbody>
      </table>
    </div>
    <p class="tiny">Sessions must be exactly half-day (4 hours), e.g. `08:00-12:00` or `13:00-17:00`.</p>
  </div>
</div>

<script>
  const DAYS = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY', 'SUNDAY'];
  const DEFAULT_PURPOSE_OPTIONS = ['ecg', 'echo', 'stress-test', 'holter', 'cardiac-bloods', 'diagnostic-consult'];
  const DEFAULT_SKILL_OPTIONS = ['ecg', 'echo', 'stress-test', 'holter', 'cardiac-bloods', 'diagnostic-consult'];

  let state = { rooms: [], employees: [], sessions: [], purposeOptions: [], skillOptions: [] };

  const roomsBody = document.getElementById('roomsBody');
  const employeesBody = document.getElementById('employeesBody');
  const sessionsBody = document.getElementById('sessionsBody');
  const message = document.getElementById('message');
  const purposeOptionsList = document.getElementById('purposeOptionsList');
  const skillOptionsList = document.getElementById('skillOptionsList');

  const uid = () => Math.random().toString(36).slice(2, 9);

  function showMessage(text, ok) {
    message.style.display = 'block';
    message.className = `message ${ok ? 'ok' : 'error'}`;
    message.textContent = text;
  }

  function toTimeValue(value) {
    return (value || '08:00:00').slice(0, 5);
  }

  function toApiTime(value) {
    if (!value) return '';
    return value.length === 5 ? `${value}:00` : value;
  }

  function daySelect(selectedDay) {
    const select = document.createElement('select');
    DAYS.forEach((day) => {
      const option = document.createElement('option');
      option.value = day;
      option.textContent = day;
      if (day === selectedDay) option.selected = true;
      select.appendChild(option);
    });
    return select;
  }

  function unique(values) {
    return Array.from(new Set((values || []).map(v => (v || '').trim()).filter(Boolean)));
  }

  function purposeCheckboxes(room) {
    if (!state.purposeOptions.length) return '<div class="tiny">Add at least one purpose above.</div>';
    return `<div class="option-grid">
      ${state.purposeOptions.map((purpose) => `
        <label class="option-check">
          <input type="checkbox" data-field="room-purpose" value="${purpose}" ${room.purpose === purpose ? 'checked' : ''} />
          <span>${purpose}</span>
        </label>
      `).join('')}
    </div>`;
  }

  function skillCheckboxes(employee) {
    if (!state.skillOptions.length) return '<div class="tiny">Add at least one skill above.</div>';
    return `<div class="option-grid">
      ${state.skillOptions.map((skill) => `
        <label class="option-check">
          <input type="checkbox" data-field="employee-skill" value="${skill}" ${(employee.skills || []).includes(skill) ? 'checked' : ''} />
          <span>${skill}</span>
        </label>
      `).join('')}
    </div>`;
  }

  function renderOptionConfig() {
    purposeOptionsList.innerHTML = state.purposeOptions.map((purpose) => `
      <span class="option-chip">
        <span>${purpose}</span>
        <button type="button" class="danger" data-action="remove-purpose-option" data-value="${purpose}">X</button>
      </span>
    `).join('');
    skillOptionsList.innerHTML = state.skillOptions.map((skill) => `
      <span class="option-chip">
        <span>${skill}</span>
        <button type="button" class="danger" data-action="remove-skill-option" data-value="${skill}">X</button>
      </span>
    `).join('');
  }

  function selectOptions(values, selected) {
    const combined = unique([...(values || []), selected || '']);
    return combined.map((value) => (
      `<option value="${value}" ${value === selected ? 'selected' : ''}>${value}</option>`
    )).join('');
  }

  function renderRooms() {
    roomsBody.innerHTML = '';
    state.rooms.forEach((room) => {
      const tr = document.createElement('tr');
      tr.dataset.id = room._uiid;

      tr.innerHTML = `
        <td><input data-field="id" value="${room.id || ''}" /></td>
        <td><input data-field="name" value="${room.name || ''}" /></td>
        <td>${purposeCheckboxes(room)}</td>
        <td><button class="danger" data-action="remove-room" type="button">Remove</button></td>
      `;
      roomsBody.appendChild(tr);
    });
  }

  function renderEmployees() {
    employeesBody.innerHTML = '';
    state.employees.forEach((employee) => {
      const tr = document.createElement('tr');
      tr.dataset.id = employee._uiid;

      const availabilityHtml = employee.availability.map((slot, idx) => `
        <div class="availability-row" data-idx="${idx}">
          <select data-field="dayOfWeek">
            ${DAYS.map(d => `<option value="${d}" ${d === slot.dayOfWeek ? 'selected' : ''}>${d}</option>`).join('')}
          </select>
          <input type="time" data-field="start" value="${toTimeValue(slot.start)}" />
          <input type="time" data-field="end" value="${toTimeValue(slot.end)}" />
          <button class="danger" data-action="remove-slot" type="button">X</button>
        </div>
      `).join('');

      tr.innerHTML = `
        <td><input data-field="id" value="${employee.id || ''}" /></td>
        <td><input data-field="name" value="${employee.name || ''}" /></td>
        <td>${skillCheckboxes(employee)}</td>
        <td>
          <div class="availability-list">${availabilityHtml}</div>
          <button data-action="add-slot" type="button" class="secondary" style="margin-top:6px;">Add Availability</button>
        </td>
        <td><button class="danger" data-action="remove-employee" type="button">Remove</button></td>
      `;
      employeesBody.appendChild(tr);
    });
  }

  function renderSessions() {
    sessionsBody.innerHTML = '';
    state.sessions.forEach((session) => {
      const tr = document.createElement('tr');
      tr.dataset.id = session._uiid;

      tr.innerHTML = `
        <td><input data-field="id" value="${session.id || ''}" /></td>
        <td><input data-field="name" value="${session.name || ''}" /></td>
        <td>
          <select data-field="requiredSkill">
            ${selectOptions(state.skillOptions, session.requiredSkill || '')}
          </select>
        </td>
        <td>
          <select data-field="purpose">
            ${selectOptions(state.purposeOptions, session.purpose || '')}
          </select>
        </td>
        <td data-day></td>
        <td><input type="time" data-field="start" value="${toTimeValue(session.start)}" /></td>
        <td><input type="time" data-field="end" value="${toTimeValue(session.end)}" /></td>
        <td><button class="danger" data-action="remove-session" type="button">Remove</button></td>
      `;

      tr.querySelector('[data-day]').appendChild(daySelect(session.dayOfWeek || 'MONDAY'));
      sessionsBody.appendChild(tr);
    });
  }

  function renderAll() {
    renderOptionConfig();
    renderRooms();
    renderEmployees();
    renderSessions();
  }

  function parseStateFromDom() {
    const rooms = Array.from(roomsBody.querySelectorAll('tr')).map((tr) => ({
      purpose: (tr.querySelector('input[data-field="room-purpose"]:checked') || {}).value || '',
      id: tr.querySelector('input[data-field="id"]').value.trim(),
      name: tr.querySelector('input[data-field="name"]').value.trim(),
    }));

    const employees = Array.from(employeesBody.querySelectorAll('tr')).map((tr) => {
      const availability = Array.from(tr.querySelectorAll('.availability-row')).map((row) => ({
        dayOfWeek: row.querySelector('select[data-field="dayOfWeek"]').value,
        start: toApiTime(row.querySelector('input[data-field="start"]').value),
        end: toApiTime(row.querySelector('input[data-field="end"]').value)
      }));
      const skills = Array.from(tr.querySelectorAll('input[data-field="employee-skill"]:checked')).map((item) => item.value);

      return {
        id: tr.querySelector('input[data-field="id"]').value.trim(),
        name: tr.querySelector('input[data-field="name"]').value.trim(),
        skills,
        availability
      };
    });

    const sessions = Array.from(sessionsBody.querySelectorAll('tr')).map((tr) => ({
      id: tr.querySelector('input[data-field="id"]').value.trim(),
      name: tr.querySelector('input[data-field="name"]').value.trim(),
      requiredSkill: (tr.querySelector('select[data-field="requiredSkill"]')?.value || '').trim(),
      purpose: (tr.querySelector('select[data-field="purpose"]')?.value || '').trim(),
      dayOfWeek: tr.querySelector('td[data-day] select').value,
      start: toApiTime(tr.querySelector('input[data-field="start"]').value),
      end: toApiTime(tr.querySelector('input[data-field="end"]').value)
    }));

    return {
      rooms,
      employees,
      sessions,
      purposeOptions: unique(state.purposeOptions),
      skillOptions: unique(state.skillOptions)
    };
  }

  async function loadState() {
    try {
      const res = await fetch('/api/state');
      const data = await res.json();
      if (!res.ok) {
        showMessage(data.error || 'Failed to load state', false);
        return;
      }

      state = {
        rooms: (data.rooms || []).map(r => ({ ...r, _uiid: uid() })),
        employees: (data.employees || []).map(e => ({
          ...e,
          availability: e.availability || [],
          _uiid: uid()
        })),
        sessions: (data.sessions || data.jobs || []).map(s => ({ ...s, _uiid: uid() })),
        purposeOptions: unique([
          ...(data.purposeOptions || []),
          ...((data.rooms || []).map(r => r.purpose)),
          ...((data.sessions || data.jobs || []).map(s => s.purpose))
        ]),
        skillOptions: unique([
          ...(data.skillOptions || []),
          ...((data.employees || []).flatMap(e => e.skills || [])),
          ...((data.sessions || data.jobs || []).map(s => s.requiredSkill))
        ])
      };
      if (state.purposeOptions.length === 0) state.purposeOptions = [...DEFAULT_PURPOSE_OPTIONS];
      if (state.skillOptions.length === 0) state.skillOptions = [...DEFAULT_SKILL_OPTIONS];

      renderAll();
      showMessage('Loaded current saved data.', true);
    } catch (e) {
      showMessage(e.message, false);
    }
  }

  async function saveState() {
    try {
      const payload = parseStateFromDom();
      const res = await fetch('/api/state', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) {
        showMessage(data.error || 'Failed to save state', false);
        return;
      }
      showMessage('Saved all changes to shared data file.', true);
      await loadState();
    } catch (e) {
      showMessage(e.message, false);
    }
  }

  document.getElementById('addRoomBtn').addEventListener('click', () => {
    state.rooms.push({ _uiid: uid(), id: '', name: '', purpose: state.purposeOptions[0] || '' });
    renderRooms();
  });

  document.getElementById('addEmployeeBtn').addEventListener('click', () => {
    state.employees.push({ _uiid: uid(), id: '', name: '', skills: [], availability: [] });
    renderEmployees();
  });

  document.getElementById('addSessionBtn').addEventListener('click', () => {
    state.sessions.push({
      _uiid: uid(),
      id: '',
      name: '',
      requiredSkill: state.skillOptions[0] || '',
      purpose: state.purposeOptions[0] || '',
      dayOfWeek: 'MONDAY',
      start: '08:00:00',
      end: '12:00:00'
    });
    renderSessions();
  });

  document.getElementById('addPurposeBtn').addEventListener('click', () => {
    const input = document.getElementById('newPurposeInput');
    const value = (input.value || '').trim();
    if (!value) return;
    state.purposeOptions = unique([...state.purposeOptions, value]);
    input.value = '';
    renderAll();
  });

  document.getElementById('addSkillBtn').addEventListener('click', () => {
    const input = document.getElementById('newSkillInput');
    const value = (input.value || '').trim();
    if (!value) return;
    state.skillOptions = unique([...state.skillOptions, value]);
    input.value = '';
    renderAll();
  });

  purposeOptionsList.addEventListener('click', (e) => {
    if (e.target.dataset.action === 'remove-purpose-option') {
      const value = e.target.dataset.value;
      const purposeUsedByRoom = state.rooms.some((room) => room.purpose === value);
      const purposeUsedBySession = state.sessions.some((session) => session.purpose === value);
      if (purposeUsedByRoom || purposeUsedBySession) {
        showMessage(`Cannot remove purpose "${value}" while it is used by rooms or sessions. Reassign those entries first.`, false);
        return;
      }
      state.purposeOptions = state.purposeOptions.filter(v => v !== value);
      renderAll();
    }
  });

  skillOptionsList.addEventListener('click', (e) => {
    if (e.target.dataset.action === 'remove-skill-option') {
      const value = e.target.dataset.value;
      const skillUsedByEmployee = state.employees.some((employee) => (employee.skills || []).includes(value));
      const skillUsedBySession = state.sessions.some((session) => session.requiredSkill === value);
      if (skillUsedByEmployee || skillUsedBySession) {
        showMessage(`Cannot remove skill "${value}" while it is used by employees or sessions. Reassign those entries first.`, false);
        return;
      }
      state.skillOptions = state.skillOptions.filter(v => v !== value);
      renderAll();
    }
  });

  roomsBody.addEventListener('click', (e) => {
    if (e.target.dataset.action === 'remove-room') {
      const id = e.target.closest('tr').dataset.id;
      state.rooms = state.rooms.filter(r => r._uiid !== id);
      renderRooms();
    }
  });

  roomsBody.addEventListener('change', (e) => {
    if (e.target.dataset.field === 'room-purpose' && e.target.checked) {
      const tr = e.target.closest('tr');
      tr.querySelectorAll('input[data-field="room-purpose"]').forEach((checkbox) => {
        if (checkbox !== e.target) checkbox.checked = false;
      });
    }
  });

  employeesBody.addEventListener('click', (e) => {
    const action = e.target.dataset.action;
    const tr = e.target.closest('tr');
    if (!tr) return;
    const id = tr.dataset.id;
    const employee = state.employees.find(emp => emp._uiid === id);
    if (!employee) return;

    if (action === 'remove-employee') {
      state.employees = state.employees.filter(emp => emp._uiid !== id);
      renderEmployees();
      return;
    }

    if (action === 'add-slot') {
      employee.availability.push({ dayOfWeek: 'MONDAY', start: '08:00:00', end: '12:00:00' });
      renderEmployees();
      return;
    }

    if (action === 'remove-slot') {
      const row = e.target.closest('.availability-row');
      const idx = Number(row.dataset.idx);
      employee.availability.splice(idx, 1);
      renderEmployees();
    }
  });

  sessionsBody.addEventListener('click', (e) => {
    if (e.target.dataset.action === 'remove-session') {
      const id = e.target.closest('tr').dataset.id;
      state.sessions = state.sessions.filter(s => s._uiid !== id);
      renderSessions();
    }
  });

  document.getElementById('loadBtn').addEventListener('click', loadState);
  document.getElementById('saveBtn').addEventListener('click', saveState);

  (async () => {
    await loadState();
  })();
</script>
</body>
</html>
