<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NHS Cardiology Scheduler - Schedule</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --md-primary: #19673b;
      --md-primary-weak: #deeee3;
      --md-on-primary: #ffffff;
      --md-surface: #ffffff;
      --md-surface-soft: #f7faf8;
      --md-bg: #eef2ef;
      --md-on-surface: #1a201c;
      --md-on-surface-muted: #5f675f;
      --md-outline: #c6cec8;
      --md-error: #b3261e;
      --md-shadow-1: 0 1px 2px rgba(0, 0, 0, 0.12);
      --md-shadow-2: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Roboto", "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 100% -10%, #dbece1 0%, transparent 35%),
        radial-gradient(circle at -10% 110%, #dfe8ff 0%, transparent 40%),
        var(--md-bg);
      color: var(--md-on-surface);
    }
    .app-shell { min-height: 100vh; }
    .wrap { max-width: 1380px; margin: 0 auto; padding: 20px 16px 36px; }
    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom: 1px solid var(--md-outline);
      background: color-mix(in srgb, var(--md-surface) 88%, transparent);
      backdrop-filter: blur(8px);
      box-shadow: var(--md-shadow-1);
    }
    .topbar-inner {
      max-width: 1380px;
      margin: 0 auto;
      padding: 12px 16px;
      display: grid;
      gap: 8px;
    }
    h1 {
      margin: 0;
      font-size: 1.45rem;
      letter-spacing: 0.01em;
      font-weight: 700;
    }
    .subtitle { margin: 0; color: var(--md-on-surface-muted); font-size: 0.95rem; }
    .nav {
      display: flex;
      gap: 8px;
      margin: 0;
    }
    .nav a {
      text-decoration: none;
      border: 1px solid var(--md-outline);
      border-radius: 999px;
      padding: 7px 14px;
      color: var(--md-on-surface);
      background: var(--md-surface);
      font-weight: 500;
      transition: background 120ms ease, border-color 120ms ease;
    }
    .nav a:hover { background: var(--md-surface-soft); }
    .nav a.active {
      border-color: transparent;
      background: var(--md-primary);
      color: var(--md-on-primary);
      box-shadow: var(--md-shadow-1);
    }
    .file-path {
      margin: 0 0 16px;
      padding: 10px 12px;
      background: var(--md-surface);
      border: 1px solid var(--md-outline);
      border-radius: 12px;
      font-size: 0.9rem;
      word-break: break-all;
      box-shadow: var(--md-shadow-1);
    }
    .actions { display: flex; flex-wrap: wrap; gap: 10px; margin: 0 0 12px; }
    button {
      border: 0;
      border-radius: 999px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 500;
      letter-spacing: 0.01em;
      color: var(--md-on-primary);
      background: var(--md-primary);
      box-shadow: var(--md-shadow-1);
      transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
    }
    button:hover { filter: brightness(1.04); box-shadow: var(--md-shadow-2); }
    button:active { transform: translateY(1px); }
    button.secondary {
      background: color-mix(in srgb, var(--md-primary) 16%, var(--md-surface));
      color: var(--md-primary);
      border: 1px solid color-mix(in srgb, var(--md-primary) 30%, transparent);
    }
    .message {
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      display: none;
      box-shadow: var(--md-shadow-1);
    }
    .message.ok { background: var(--md-primary-weak); border-color: color-mix(in srgb, var(--md-primary) 35%, transparent); }
    .message.error { background: #fde9e8; border-color: #f3beb9; color: var(--md-error); }
    .panel {
      background: var(--md-surface);
      border: 1px solid var(--md-outline);
      border-radius: 16px;
      padding: 14px;
      margin-top: 14px;
      box-shadow: var(--md-shadow-2);
    }
    .panel h2 { margin: 0 0 10px; font-size: 1.1rem; font-weight: 600; }
    .calendar-wrap {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--md-outline);
    }
    .timetable {
      width: 100%;
      min-width: 1300px;
      border-collapse: collapse;
      background: #fcfefd;
    }
    .timetable th,
    .timetable td {
      border: 1px solid var(--md-outline);
      padding: 8px;
      vertical-align: top;
    }
    .timetable thead th {
      background: #edf4f0;
      font-weight: 600;
      text-align: center;
    }
    .room-header {
      text-align: left !important;
      min-width: 180px;
      position: sticky;
      left: 0;
      z-index: 1;
      background: #edf4f0;
    }
    .room-cell {
      background: #f2f7f3;
      font-weight: 600;
      position: sticky;
      left: 0;
      z-index: 1;
    }
    .slot-cell {
      min-width: 120px;
      min-height: 74px;
    }
    .assignment-card {
      border: 1px solid #c3d2c8;
      border-left: 4px solid var(--md-primary);
      border-radius: 10px;
      padding: 8px;
      background: #f8fcf9;
      font-size: 0.84rem;
      box-shadow: var(--md-shadow-1);
    }
    .assignment-staff {
      color: var(--md-on-surface-muted);
      margin-top: 2px;
    }
    .assignment-override {
      margin-top: 6px;
    }
    .assignment-override button {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.78rem;
      line-height: 1.1;
    }
    .empty-slot {
      color: var(--md-on-surface-muted);
      font-size: 0.82rem;
      font-style: italic;
    }
    .unscheduled-list { margin: 10px 0 0; padding-left: 18px; }
    .unscheduled-list li { margin-bottom: 4px; color: var(--md-error); }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(19, 28, 22, 0.48);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 40;
    }
    .modal-backdrop.open { display: flex; }
    .modal {
      width: min(560px, 100%);
      max-height: calc(100vh - 48px);
      overflow: auto;
      background: var(--md-surface);
      border: 1px solid var(--md-outline);
      border-radius: 16px;
      box-shadow: var(--md-shadow-2);
      padding: 16px;
    }
    .modal h3 {
      margin: 0 0 4px;
      font-size: 1.1rem;
    }
    .modal-subtitle {
      margin: 0 0 12px;
      color: var(--md-on-surface-muted);
      font-size: 0.9rem;
    }
    .candidate-list {
      display: grid;
      gap: 8px;
      margin-bottom: 12px;
    }
    .candidate-item {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      border: 1px solid var(--md-outline);
      border-radius: 10px;
      padding: 10px;
      background: #f9fbf9;
    }
    .candidate-item input {
      margin-top: 2px;
    }
    .candidate-name { font-weight: 600; }
    .candidate-meta { color: var(--md-on-surface-muted); font-size: 0.84rem; margin-top: 2px; }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .empty-candidates {
      border: 1px dashed var(--md-outline);
      border-radius: 10px;
      padding: 10px;
      color: var(--md-on-surface-muted);
      font-style: italic;
      margin-bottom: 12px;
    }
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 0.9rem;
    }
    @media (max-width: 720px) {
      .wrap { padding: 14px 10px 24px; }
      .topbar-inner { padding: 10px; }
      h1 { font-size: 1.2rem; }
      .subtitle { font-size: 0.86rem; }
      .panel { border-radius: 12px; padding: 10px; }
      .actions { gap: 8px; }
      button { padding: 9px 14px; }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <div class="topbar">
    <div class="topbar-inner">
      <h1>NHS Cardiology Scheduler</h1>
      <p class="subtitle">Schedule view. Configure rooms, employees, and sessions on the separate config page.</p>
      <div class="nav">
        <a href="/" class="active">Schedule</a>
        <a href="/config.html">Configure Data</a>
      </div>
    </div>
  </div>
  <div class="wrap">
    <div id="filePath" class="file-path">Data file: loading...</div>

    <div class="actions">
      <button id="generateBtn">Generate Weekly Schedule</button>
      <button id="reloadBtn" class="secondary">Reload From Saved Data</button>
    </div>

    <div id="message" class="message"><pre id="messageText"></pre></div>

    <div class="panel">
      <h2>Weekly Calendar</h2>
      <div class="calendar-wrap">
        <table id="calendarTable" class="timetable"></table>
      </div>
      <h2 style="margin-top: 14px;">Unscheduled Sessions</h2>
      <ul id="unscheduledOutput" class="unscheduled-list"></ul>
    </div>
  </div>

  <div id="overrideModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Override Assigned Employee</h3>
      <p id="overrideModalSubtitle" class="modal-subtitle"></p>
      <div id="overrideCandidateList" class="candidate-list"></div>
      <div id="overrideEmptyState" class="empty-candidates" style="display:none;">No valid employees available for this session.</div>
      <div class="modal-actions">
        <button id="overrideCancelBtn" type="button" class="secondary">Cancel</button>
        <button id="overrideApplyBtn" type="button">Apply Override</button>
      </div>
    </div>
  </div>
</div>

<script>
  const DAY_ORDER = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY', 'SUNDAY'];
  const filePath = document.getElementById('filePath');
  const message = document.getElementById('message');
  const messageText = document.getElementById('messageText');
  const calendarTable = document.getElementById('calendarTable');
  const unscheduledOutput = document.getElementById('unscheduledOutput');
  const overrideModalBackdrop = document.getElementById('overrideModalBackdrop');
  const overrideModalSubtitle = document.getElementById('overrideModalSubtitle');
  const overrideCandidateList = document.getElementById('overrideCandidateList');
  const overrideEmptyState = document.getElementById('overrideEmptyState');
  let rooms = [];
  let employees = [];
  let currentSchedule = { assignments: [], unscheduledSessions: [] };
  let activeOverrideAssignment = null;

  function showMessage(text, ok) {
    message.style.display = 'block';
    message.className = `message ${ok ? 'ok' : 'error'}`;
    messageText.textContent = text;
  }

  function getHalfDaySlot(startTime) {
    const value = (startTime || '').slice(0, 5);
    return value < '12:00' ? 'AM' : 'PM';
  }

  function isAvailable(employee, session) {
    return (employee.availability || []).some((window) => (
      window.dayOfWeek === session.dayOfWeek
      && window.start <= session.start
      && window.end >= session.end
    ));
  }

  function overlaps(aStart, aEnd, bStart, bEnd) {
    return aStart < bEnd && bStart < aEnd;
  }

  function hasConflict(employeeId, targetSession, targetSessionId) {
    const assignments = currentSchedule.assignments || [];
    return assignments
      .filter((assignment) => assignment?.employee?.id === employeeId)
      .filter((assignment) => assignment?.session?.id !== targetSessionId)
      .filter((assignment) => assignment?.session?.dayOfWeek === targetSession.dayOfWeek)
      .some((assignment) => overlaps(
        assignment.session.start,
        assignment.session.end,
        targetSession.start,
        targetSession.end
      ));
  }

  function findEligibleEmployees(assignment) {
    const session = assignment.session;
    const requiredSkill = (session.requiredSkill || '').toLowerCase();
    return (employees || []).filter((employee) => {
      const skillMatch = (employee.skills || []).some((skill) => (skill || '').toLowerCase() === requiredSkill);
      return skillMatch
        && isAvailable(employee, session)
        && !hasConflict(employee.id, session, session.id);
    });
  }

  function closeOverrideModal() {
    overrideModalBackdrop.classList.remove('open');
    activeOverrideAssignment = null;
    overrideCandidateList.innerHTML = '';
    overrideEmptyState.style.display = 'none';
  }

  function openOverrideModal(assignment) {
    activeOverrideAssignment = assignment;
    const eligibleEmployees = findEligibleEmployees(assignment);
    overrideModalSubtitle.textContent = `${assignment.session.name} (${assignment.session.dayOfWeek} ${assignment.session.start.slice(0, 5)}-${assignment.session.end.slice(0, 5)})`;
    overrideCandidateList.innerHTML = '';

    if (eligibleEmployees.length === 0) {
      overrideEmptyState.style.display = 'block';
    } else {
      overrideEmptyState.style.display = 'none';
      eligibleEmployees.forEach((employee, idx) => {
        const wrapper = document.createElement('label');
        wrapper.className = 'candidate-item';
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'override-employee';
        radio.value = employee.id;
        if (employee.id === assignment.employee.id || (idx === 0 && !eligibleEmployees.some((e) => e.id === assignment.employee.id))) {
          radio.checked = true;
        }
        const detail = document.createElement('div');
        const name = document.createElement('div');
        name.className = 'candidate-name';
        name.textContent = employee.name;
        const meta = document.createElement('div');
        meta.className = 'candidate-meta';
        meta.textContent = `${employee.id} â€¢ skills: ${(employee.skills || []).join(', ')}`;
        detail.appendChild(name);
        detail.appendChild(meta);
        wrapper.appendChild(radio);
        wrapper.appendChild(detail);
        overrideCandidateList.appendChild(wrapper);
      });
    }
    overrideModalBackdrop.classList.add('open');
  }

  function buildCalendar(result) {
    currentSchedule = result || { assignments: [], unscheduledSessions: [] };
    calendarTable.innerHTML = '';
    unscheduledOutput.innerHTML = '';

    const assignments = (result && result.assignments) ? result.assignments : [];
    const assignmentMap = new Map();
    assignments.forEach((assignment) => {
      const key = `${assignment.room.id}|${assignment.session.dayOfWeek}|${getHalfDaySlot(assignment.session.start)}`;
      if (!assignmentMap.has(key)) assignmentMap.set(key, []);
      assignmentMap.get(key).push(assignment);
    });

    const thead = document.createElement('thead');
    const dayHeaderRow = document.createElement('tr');
    const roomHeader = document.createElement('th');
    roomHeader.textContent = 'Room';
    roomHeader.className = 'room-header';
    roomHeader.rowSpan = 2;
    dayHeaderRow.appendChild(roomHeader);
    DAY_ORDER.forEach((day) => {
      const th = document.createElement('th');
      th.colSpan = 2;
      th.textContent = day;
      dayHeaderRow.appendChild(th);
    });
    const slotHeaderRow = document.createElement('tr');
    DAY_ORDER.forEach(() => {
      const am = document.createElement('th');
      am.textContent = 'AM';
      const pm = document.createElement('th');
      pm.textContent = 'PM';
      slotHeaderRow.appendChild(am);
      slotHeaderRow.appendChild(pm);
    });
    thead.appendChild(dayHeaderRow);
    thead.appendChild(slotHeaderRow);
    calendarTable.appendChild(thead);

    const tbody = document.createElement('tbody');
    rooms.forEach((room) => {
      const tr = document.createElement('tr');
      const roomCell = document.createElement('td');
      roomCell.className = 'room-cell';
      roomCell.textContent = room.name || room.id;
      tr.appendChild(roomCell);

      DAY_ORDER.forEach((day) => {
        ['AM', 'PM'].forEach((slot) => {
          const cell = document.createElement('td');
          cell.className = 'slot-cell';
          const key = `${room.id}|${day}|${slot}`;
          const slotAssignments = assignmentMap.get(key) || [];
          if (slotAssignments.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'empty-slot';
            empty.textContent = 'No session';
            cell.appendChild(empty);
          } else {
            slotAssignments.forEach((assignment) => {
              const card = document.createElement('div');
              card.className = 'assignment-card';
              const session = document.createElement('div');
              session.textContent = assignment.session.name;
              const staff = document.createElement('div');
              staff.className = 'assignment-staff';
              staff.textContent = assignment.employee.name;
              const override = document.createElement('div');
              override.className = 'assignment-override';
              const button = document.createElement('button');
              button.type = 'button';
              button.className = 'secondary';
              button.textContent = 'Override';
              button.addEventListener('click', () => openOverrideModal(assignment));
              card.appendChild(session);
              card.appendChild(staff);
              override.appendChild(button);
              card.appendChild(override);
              cell.appendChild(card);
            });
          }
          tr.appendChild(cell);
        });
      });
      tbody.appendChild(tr);
    });
    calendarTable.appendChild(tbody);

    const unscheduled = result?.unscheduledSessions || [];
    if (unscheduled.length === 0) {
      const li = document.createElement('li');
      li.style.color = '#2f5f45';
      li.textContent = 'All sessions scheduled.';
      unscheduledOutput.appendChild(li);
    } else {
      unscheduled.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = `${item.session.id} (${item.session.name}): ${item.reason}`;
        unscheduledOutput.appendChild(li);
      });
    }
  }

  async function loadMeta() {
    const res = await fetch('/api/meta');
    const meta = await res.json();
    filePath.textContent = `Data file: ${meta.dataFile}`;
  }

  async function loadRooms() {
    const res = await fetch('/api/state');
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.error || 'Failed to load rooms');
    }
    rooms = data.rooms || [];
    employees = data.employees || [];
  }

  async function overrideAssignment(sessionId, employeeId) {
    try {
      const res = await fetch('/api/schedule/override', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionId, employeeId })
      });
      const data = await res.json();
      if (!res.ok) {
        showMessage(data.error || 'Failed to override employee assignment', false);
        return;
      }
      await loadRooms();
      buildCalendar(data);
      showMessage('Employee override saved.', true);
    } catch (e) {
      showMessage(e.message, false);
    }
  }

  async function loadSchedule() {
    try {
      const res = await fetch('/api/schedule');
      const data = await res.json();
      if (!res.ok) {
        showMessage(data.error || 'Failed to load schedule', false);
        return;
      }
      await loadRooms();
      buildCalendar(data);
      showMessage('Loaded saved schedule.', true);
    } catch (e) {
      showMessage(e.message, false);
    }
  }

  async function generateSchedule() {
    try {
      const res = await fetch('/api/schedule', { method: 'POST' });
      const data = await res.json();
      if (!res.ok) {
        showMessage(data.error || 'Failed to generate schedule', false);
        return;
      }
      await loadRooms();
      buildCalendar(data);
      showMessage('Schedule generated.', true);
    } catch (e) {
      showMessage(e.message, false);
    }
  }

  document.getElementById('generateBtn').addEventListener('click', generateSchedule);
  document.getElementById('reloadBtn').addEventListener('click', loadSchedule);
  document.getElementById('overrideCancelBtn').addEventListener('click', closeOverrideModal);
  document.getElementById('overrideApplyBtn').addEventListener('click', async () => {
    if (!activeOverrideAssignment) return;
    const selected = overrideCandidateList.querySelector('input[name="override-employee"]:checked');
    if (!selected) {
      showMessage('Select an employee to apply override.', false);
      return;
    }
    await overrideAssignment(activeOverrideAssignment.session.id, selected.value);
    closeOverrideModal();
  });
  overrideModalBackdrop.addEventListener('click', (e) => {
    if (e.target === overrideModalBackdrop) closeOverrideModal();
  });

  (async () => {
    await loadMeta();
    await loadRooms();
    buildCalendar({ assignments: [], unscheduledSessions: [] });
    await loadSchedule();
  })();
</script>
</body>
</html>
