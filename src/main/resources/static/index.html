<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NHS Cardiology Scheduler - Schedule</title>
  <style>
    :root {
      --bg: #f4f7f3;
      --panel: #ffffff;
      --ink: #13231a;
      --accent: #00703c;
      --accent-soft: #d7efe1;
      --warn: #a32020;
      --border: #c6d9cc;
      --muted: #6f8378;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Gill Sans", "Trebuchet MS", sans-serif;
      background: radial-gradient(circle at top right, #e4f3e9, var(--bg));
      color: var(--ink);
    }
    .wrap { max-width: 1300px; margin: 0 auto; padding: 24px 16px 40px; }
    h1 { margin: 0 0 6px; font-size: 2rem; letter-spacing: 0.02em; }
    .subtitle { margin-bottom: 10px; color: #32483a; }
    .nav {
      display: flex;
      gap: 10px;
      margin: 0 0 16px;
    }
    .nav a {
      text-decoration: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--ink);
      background: #f8fcf9;
      font-weight: 600;
    }
    .nav a.active { background: var(--accent-soft); }
    .file-path {
      margin: 0 0 16px;
      padding: 8px 10px;
      background: var(--accent-soft);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      word-break: break-all;
    }
    .actions { display: flex; flex-wrap: wrap; gap: 10px; margin: 0 0 12px; }
    button {
      border: 0;
      border-radius: 8px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
      color: white;
      background: var(--accent);
    }
    button.secondary { background: #3f5f50; }
    .message {
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid transparent;
      display: none;
    }
    .message.ok { background: var(--accent-soft); border-color: var(--border); }
    .message.error { background: #f8dede; border-color: #e7bbbb; color: var(--warn); }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin-top: 14px;
    }
    .panel h2 { margin: 0 0 8px; font-size: 1.1rem; }
    .calendar-wrap {
      overflow-x: auto;
    }
    .timetable {
      width: 100%;
      min-width: 1300px;
      border-collapse: collapse;
      border: 1px solid var(--border);
      background: #fcfffd;
    }
    .timetable th,
    .timetable td {
      border: 1px solid var(--border);
      padding: 8px;
      vertical-align: top;
    }
    .timetable thead th {
      background: #eff8f2;
      font-weight: 700;
      text-align: center;
    }
    .room-header {
      text-align: left !important;
      min-width: 180px;
      position: sticky;
      left: 0;
      z-index: 1;
      background: #eff8f2;
    }
    .room-cell {
      background: #f4faf6;
      font-weight: 600;
      position: sticky;
      left: 0;
      z-index: 1;
    }
    .slot-cell {
      min-width: 120px;
      min-height: 74px;
    }
    .assignment-card {
      border: 1px solid #b8d2c2;
      border-left: 4px solid var(--accent);
      border-radius: 7px;
      padding: 6px;
      background: #f8fdf9;
      font-size: 0.84rem;
    }
    .assignment-staff {
      color: #355344;
      margin-top: 2px;
    }
    .empty-slot {
      color: var(--muted);
      font-size: 0.82rem;
      font-style: italic;
    }
    .unscheduled-list { margin: 10px 0 0; padding-left: 18px; }
    .unscheduled-list li { margin-bottom: 4px; color: var(--warn); }
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>NHS Cardiology Scheduler</h1>
  <p class="subtitle">Schedule view. Configure rooms, employees, and sessions on the separate config page.</p>

  <div class="nav">
    <a href="/" class="active">Schedule</a>
    <a href="/config.html">Configure Data</a>
  </div>

  <div id="filePath" class="file-path">Data file: loading...</div>

  <div class="actions">
    <button id="generateBtn">Generate Weekly Schedule</button>
    <button id="reloadBtn" class="secondary">Reload From Saved Data</button>
  </div>

  <div id="message" class="message"><pre id="messageText"></pre></div>

  <div class="panel">
    <h2>Weekly Calendar</h2>
    <div class="calendar-wrap">
      <table id="calendarTable" class="timetable"></table>
    </div>
    <h2 style="margin-top: 14px;">Unscheduled Sessions</h2>
    <ul id="unscheduledOutput" class="unscheduled-list"></ul>
  </div>

</div>

<script>
  const DAY_ORDER = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY', 'SUNDAY'];
  const filePath = document.getElementById('filePath');
  const message = document.getElementById('message');
  const messageText = document.getElementById('messageText');
  const calendarTable = document.getElementById('calendarTable');
  const unscheduledOutput = document.getElementById('unscheduledOutput');
  let rooms = [];

  function showMessage(text, ok) {
    message.style.display = 'block';
    message.className = `message ${ok ? 'ok' : 'error'}`;
    messageText.textContent = text;
  }

  function getHalfDaySlot(startTime) {
    const value = (startTime || '').slice(0, 5);
    return value < '12:00' ? 'AM' : 'PM';
  }

  function buildCalendar(result) {
    calendarTable.innerHTML = '';
    unscheduledOutput.innerHTML = '';

    const assignments = (result && result.assignments) ? result.assignments : [];
    const assignmentMap = new Map();
    assignments.forEach((assignment) => {
      const key = `${assignment.room.id}|${assignment.session.dayOfWeek}|${getHalfDaySlot(assignment.session.start)}`;
      if (!assignmentMap.has(key)) assignmentMap.set(key, []);
      assignmentMap.get(key).push(assignment);
    });

    const thead = document.createElement('thead');
    const dayHeaderRow = document.createElement('tr');
    const roomHeader = document.createElement('th');
    roomHeader.textContent = 'Room';
    roomHeader.className = 'room-header';
    roomHeader.rowSpan = 2;
    dayHeaderRow.appendChild(roomHeader);
    DAY_ORDER.forEach((day) => {
      const th = document.createElement('th');
      th.colSpan = 2;
      th.textContent = day;
      dayHeaderRow.appendChild(th);
    });
    const slotHeaderRow = document.createElement('tr');
    DAY_ORDER.forEach(() => {
      const am = document.createElement('th');
      am.textContent = 'AM';
      const pm = document.createElement('th');
      pm.textContent = 'PM';
      slotHeaderRow.appendChild(am);
      slotHeaderRow.appendChild(pm);
    });
    thead.appendChild(dayHeaderRow);
    thead.appendChild(slotHeaderRow);
    calendarTable.appendChild(thead);

    const tbody = document.createElement('tbody');
    rooms.forEach((room) => {
      const tr = document.createElement('tr');
      const roomCell = document.createElement('td');
      roomCell.className = 'room-cell';
      roomCell.textContent = room.name || room.id;
      tr.appendChild(roomCell);

      DAY_ORDER.forEach((day) => {
        ['AM', 'PM'].forEach((slot) => {
          const cell = document.createElement('td');
          cell.className = 'slot-cell';
          const key = `${room.id}|${day}|${slot}`;
          const slotAssignments = assignmentMap.get(key) || [];
          if (slotAssignments.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'empty-slot';
            empty.textContent = 'No session';
            cell.appendChild(empty);
          } else {
            slotAssignments.forEach((assignment) => {
              const card = document.createElement('div');
              card.className = 'assignment-card';
              const session = document.createElement('div');
              session.textContent = assignment.session.name;
              const staff = document.createElement('div');
              staff.className = 'assignment-staff';
              staff.textContent = assignment.employee.name;
              card.appendChild(session);
              card.appendChild(staff);
              cell.appendChild(card);
            });
          }
          tr.appendChild(cell);
        });
      });
      tbody.appendChild(tr);
    });
    calendarTable.appendChild(tbody);

    const unscheduled = result?.unscheduledSessions || [];
    if (unscheduled.length === 0) {
      const li = document.createElement('li');
      li.style.color = '#2f5f45';
      li.textContent = 'All sessions scheduled.';
      unscheduledOutput.appendChild(li);
    } else {
      unscheduled.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = `${item.session.id} (${item.session.name}): ${item.reason}`;
        unscheduledOutput.appendChild(li);
      });
    }
  }

  async function loadMeta() {
    const res = await fetch('/api/meta');
    const meta = await res.json();
    filePath.textContent = `Data file: ${meta.dataFile}`;
  }

  async function loadRooms() {
    const res = await fetch('/api/state');
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.error || 'Failed to load rooms');
    }
    rooms = data.rooms || [];
  }

  async function loadSchedule() {
    try {
      const res = await fetch('/api/schedule');
      const data = await res.json();
      if (!res.ok) {
        showMessage(data.error || 'Failed to load schedule', false);
        return;
      }
      await loadRooms();
      buildCalendar(data);
      showMessage('Loaded saved schedule.', true);
    } catch (e) {
      showMessage(e.message, false);
    }
  }

  async function generateSchedule() {
    try {
      const res = await fetch('/api/schedule', { method: 'POST' });
      const data = await res.json();
      if (!res.ok) {
        showMessage(data.error || 'Failed to generate schedule', false);
        return;
      }
      await loadRooms();
      buildCalendar(data);
      showMessage('Schedule generated.', true);
    } catch (e) {
      showMessage(e.message, false);
    }
  }

  document.getElementById('generateBtn').addEventListener('click', generateSchedule);
  document.getElementById('reloadBtn').addEventListener('click', loadSchedule);

  (async () => {
    await loadMeta();
    await loadRooms();
    buildCalendar({ assignments: [], unscheduledSessions: [] });
    await loadSchedule();
  })();
</script>
</body>
</html>
